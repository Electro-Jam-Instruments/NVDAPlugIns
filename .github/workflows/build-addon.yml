# Build and Release NVDA Addon
#
# Triggers ONLY when version tags are created (not on branch pushes)
# Tag pattern: pluginname-vX.X.X or pluginname-vX.X.X-beta
#
# Beta tags (ending in -beta) create pre-releases
# Release tags (no suffix) create stable releases
#
# Uses standard NVDA scons build system

name: Build NVDA Addon

on:
  push:
    tags:
      - '*-v[0-9]+.[0-9]+.[0-9]+'
      - '*-v[0-9]+.[0-9]+.[0-9]+-beta'
    branches-ignore:
      - '**'

jobs:
  build:
    runs-on: ubuntu-latest
    # Ensure we only run for actual tag pushes
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scons
          pip install Markdown

      - name: Parse tag info
        id: tag_info
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Extract plugin name (everything before -vX.X.X)
          PLUGIN_NAME=$(echo "$TAG" | sed 's/-v[0-9]*\.[0-9]*\.[0-9]*.*$//')
          echo "plugin_name=$PLUGIN_NAME" >> $GITHUB_OUTPUT

          # Extract version (X.X.X, without -beta suffix)
          VERSION=$(echo "$TAG" | grep -oP 'v\K[0-9]+\.[0-9]+\.[0-9]+')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Check if beta
          if [[ "$TAG" == *"-beta" ]]; then
            echo "is_beta=true" >> $GITHUB_OUTPUT
            echo "release_name=$PLUGIN_NAME v$VERSION Beta" >> $GITHUB_OUTPUT
          else
            echo "is_beta=false" >> $GITHUB_OUTPUT
            echo "release_name=$PLUGIN_NAME v$VERSION" >> $GITHUB_OUTPUT
          fi

          echo "Parsed: plugin=$PLUGIN_NAME, version=$VERSION, tag=$TAG"

      - name: Validate buildVars version
        run: |
          PLUGIN_NAME="${{ steps.tag_info.outputs.plugin_name }}"
          TAG_VERSION="${{ steps.tag_info.outputs.version }}"

          BUILDVARS_PATH="$PLUGIN_NAME/buildVars.py"

          if [ ! -f "$BUILDVARS_PATH" ]; then
            echo "Error: buildVars.py not found at $BUILDVARS_PATH"
            exit 1
          fi

          BUILDVARS_VERSION=$(grep -oP 'addon_version.*"\K[0-9]+\.[0-9]+\.[0-9]+' "$BUILDVARS_PATH")

          if [ "$TAG_VERSION" != "$BUILDVARS_VERSION" ]; then
            echo "Error: Tag version ($TAG_VERSION) does not match buildVars version ($BUILDVARS_VERSION)"
            echo "Please update buildVars.py addon_version to $TAG_VERSION"
            exit 1
          fi

          echo "Version validated: $TAG_VERSION"

      - name: Build addon with scons
        run: |
          PLUGIN_NAME="${{ steps.tag_info.outputs.plugin_name }}"
          cd "$PLUGIN_NAME"
          scons

      - name: Find built addon
        id: find_addon
        run: |
          PLUGIN_NAME="${{ steps.tag_info.outputs.plugin_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"

          # Find the built addon file (name comes from buildVars addon_name)
          ADDON_FILE=$(find "$PLUGIN_NAME" -maxdepth 1 -name "*.nvda-addon" -type f | head -1)

          if [ -z "$ADDON_FILE" ] || [ ! -f "$ADDON_FILE" ]; then
            echo "Error: Built addon not found in $PLUGIN_NAME/"
            exit 1
          fi

          ADDON_BASENAME=$(basename "$ADDON_FILE")

          echo "addon_path=$ADDON_FILE" >> $GITHUB_OUTPUT
          echo "addon_name=$ADDON_BASENAME" >> $GITHUB_OUTPUT
          echo "Found addon: $ADDON_FILE"

      - name: Extract changelog for release
        id: changelog
        run: |
          PLUGIN_NAME="${{ steps.tag_info.outputs.plugin_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          IS_BETA="${{ steps.tag_info.outputs.is_beta }}"

          CHANGELOG_PATH="$PLUGIN_NAME/CHANGELOG.md"

          if [ -f "$CHANGELOG_PATH" ]; then
            # Extract the section for this version (handles both X.X.X and X.X.X-beta)
            if [ "$IS_BETA" == "true" ]; then
              SECTION_HEADER="$VERSION-beta"
            else
              SECTION_HEADER="$VERSION"
            fi

            # Extract content between this version header and the next ## header
            CHANGELOG_CONTENT=$(awk "/^## \[$SECTION_HEADER\]/{flag=1; next} /^## \[/{flag=0} flag" "$CHANGELOG_PATH" | head -50)

            if [ -z "$CHANGELOG_CONTENT" ]; then
              CHANGELOG_CONTENT="See CHANGELOG.md for details."
            fi
          else
            CHANGELOG_CONTENT="No changelog available."
          fi

          # Save to file for multiline output with source archive note
          cat > changelog_excerpt.txt << BODYEOF
$CHANGELOG_CONTENT

---

**Note:** The "Source code" downloads below contain the full repository (all plugins), not just this plugin. To install the addon, download the \`.nvda-addon\` file above.
BODYEOF
          echo "changelog_file=changelog_excerpt.txt" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.tag_info.outputs.release_name }}
          prerelease: ${{ steps.tag_info.outputs.is_beta == 'true' }}
          files: ${{ steps.find_addon.outputs.addon_path }}
          body_path: ${{ steps.changelog.outputs.changelog_file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Deploy to GitHub Pages for public downloads
      - name: Prepare Pages deployment
        run: |
          PLUGIN_NAME="${{ steps.tag_info.outputs.plugin_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          IS_BETA="${{ steps.tag_info.outputs.is_beta }}"
          ADDON_FILE="${{ steps.find_addon.outputs.addon_name }}"
          TAG="${{ steps.tag_info.outputs.tag }}"

          mkdir -p deploy/downloads

          # Copy addon file with version in name
          cp "${{ steps.find_addon.outputs.addon_path }}" deploy/downloads/

          # Also copy as "latest" for easy linking
          if [ "$IS_BETA" == "true" ]; then
            cp "${{ steps.find_addon.outputs.addon_path }}" "deploy/downloads/$PLUGIN_NAME-latest-beta.nvda-addon"
          else
            cp "${{ steps.find_addon.outputs.addon_path }}" "deploy/downloads/$PLUGIN_NAME-latest.nvda-addon"
          fi

          # Create version info JSON for this plugin
          mkdir -p deploy/api
          cat > "deploy/api/$PLUGIN_NAME.json" << JSONEOF
          {
            "plugin": "$PLUGIN_NAME",
            "version": "$VERSION",
            "is_beta": $IS_BETA,
            "tag": "$TAG",
            "file": "$ADDON_FILE",
            "updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          JSONEOF

          # Copy changelog for this plugin
          if [ -f "$PLUGIN_NAME/CHANGELOG.md" ]; then
            cp "$PLUGIN_NAME/CHANGELOG.md" "deploy/api/$PLUGIN_NAME-changelog.md"
          fi

      - name: Generate download page
        run: |
          PLUGIN_NAME="${{ steps.tag_info.outputs.plugin_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          IS_BETA="${{ steps.tag_info.outputs.is_beta }}"

          # Read existing version info or create defaults
          PPT_BETA_VER=""
          PPT_STABLE_VER=""
          WDS_BETA_VER=""
          WDS_STABLE_VER=""

          # Set current plugin version
          if [ "$PLUGIN_NAME" == "powerpoint-comments" ]; then
            if [ "$IS_BETA" == "true" ]; then
              PPT_BETA_VER="$VERSION"
            else
              PPT_STABLE_VER="$VERSION"
            fi
          elif [ "$PLUGIN_NAME" == "windows-dictation-silence" ]; then
            if [ "$IS_BETA" == "true" ]; then
              WDS_BETA_VER="$VERSION"
            else
              WDS_STABLE_VER="$VERSION"
            fi
          fi

          # Generate the HTML
          cat > deploy/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>NVDA Plugins - Electro Jam Instruments</title>
            <style>
              :root { color-scheme: light dark; }
              body {
                font-family: system-ui, -apple-system, sans-serif;
                max-width: 900px;
                margin: 2rem auto;
                padding: 1rem;
                background: Canvas;
                color: CanvasText;
                line-height: 1.6;
              }
              h1, h2, h3 { color: CanvasText; margin-top: 1.5rem; }
              h1 { border-bottom: 2px solid CanvasText; padding-bottom: 0.5rem; }
              .plugin-card {
                background: color-mix(in srgb, CanvasText 5%, Canvas);
                padding: 1.5rem;
                border-radius: 8px;
                margin: 1.5rem 0;
                border: 1px solid color-mix(in srgb, CanvasText 15%, Canvas);
              }
              .download-section {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                margin: 1rem 0;
              }
              .download-btn {
                display: inline-block;
                padding: 0.75rem 1.25rem;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 500;
              }
              .download-btn:focus {
                outline: 3px solid CanvasText;
                outline-offset: 2px;
              }
              .download-stable {
                background: #2563eb;
                color: white;
              }
              .download-beta {
                background: color-mix(in srgb, CanvasText 20%, Canvas);
                color: CanvasText;
                border: 1px solid color-mix(in srgb, CanvasText 30%, Canvas);
              }
              .version-info {
                font-size: 0.9rem;
                color: GrayText;
                margin-top: 0.5rem;
              }
              .changelog-toggle {
                background: none;
                border: 1px solid color-mix(in srgb, CanvasText 30%, Canvas);
                padding: 0.5rem 1rem;
                border-radius: 4px;
                cursor: pointer;
                color: CanvasText;
                margin-top: 1rem;
              }
              .changelog-toggle:focus {
                outline: 2px solid CanvasText;
                outline-offset: 2px;
              }
              .changelog {
                display: none;
                margin-top: 1rem;
                padding: 1rem;
                background: color-mix(in srgb, CanvasText 10%, Canvas);
                border-radius: 4px;
                max-height: 300px;
                overflow-y: auto;
              }
              .changelog.show { display: block; }
              .changelog h3 { margin-top: 0.5rem; }
              .changelog ul { margin: 0.5rem 0; padding-left: 1.5rem; }
              .requirements {
                font-size: 0.95rem;
                margin: 0.5rem 0;
              }
              .install-steps {
                background: color-mix(in srgb, CanvasText 8%, Canvas);
                padding: 1rem 1.5rem;
                border-radius: 6px;
                margin: 1rem 0;
              }
              .install-steps ol { margin: 0.5rem 0; padding-left: 1.5rem; }
              code {
                background: color-mix(in srgb, CanvasText 15%, Canvas);
                padding: 0.15rem 0.4rem;
                border-radius: 3px;
                font-size: 0.95em;
              }
              footer {
                margin-top: 3rem;
                padding-top: 1rem;
                border-top: 1px solid color-mix(in srgb, CanvasText 20%, Canvas);
                color: GrayText;
                text-align: center;
              }
              a { color: LinkText; }
              a:visited { color: VisitedText; }
            </style>
          </head>
          <body>
            <h1>NVDA Plugins</h1>
            <p>Accessibility add-ons for the <a href="https://www.nvaccess.org/">NVDA screen reader</a> by Electro Jam Instruments.</p>

            <div class="plugin-card">
              <h2>PowerPoint Comments</h2>
              <p>Hear comment counts when navigating slides. Read presenter notes with a keyboard shortcut. Works in both edit mode and slideshow mode.</p>
              <p class="requirements"><strong>Requirements:</strong> NVDA 2024.1+, Microsoft PowerPoint 365</p>

              <div class="download-section">
                <a class="download-btn download-stable" href="downloads/powerpoint-comments-latest.nvda-addon" id="ppt-stable">
                  Download Stable
                </a>
                <a class="download-btn download-beta" href="downloads/powerpoint-comments-latest-beta.nvda-addon" id="ppt-beta">
                  Download Beta
                </a>
              </div>
              <p class="version-info" id="ppt-versions">Check GitHub releases for version info</p>

              <button class="changelog-toggle" onclick="toggleChangelog('ppt-changelog')" aria-expanded="false" aria-controls="ppt-changelog">
                View Changelog
              </button>
              <div class="changelog" id="ppt-changelog" role="region" aria-label="PowerPoint Comments changelog">
                <p>Loading changelog...</p>
              </div>
            </div>

            <div class="plugin-card">
              <h2>Windows Dictation Silence</h2>
              <p>Automatically silences NVDA when Windows Voice Typing (Win+H) is active. Speech restores instantly when you press any key to close dictation.</p>
              <p class="requirements"><strong>Requirements:</strong> NVDA 2024.1+, Windows 11</p>

              <div class="download-section">
                <a class="download-btn download-stable" href="downloads/windows-dictation-silence-latest.nvda-addon" id="wds-stable">
                  Download Stable
                </a>
                <a class="download-btn download-beta" href="downloads/windows-dictation-silence-latest-beta.nvda-addon" id="wds-beta">
                  Download Beta
                </a>
              </div>
              <p class="version-info" id="wds-versions">Check GitHub releases for version info</p>

              <button class="changelog-toggle" onclick="toggleChangelog('wds-changelog')" aria-expanded="false" aria-controls="wds-changelog">
                View Changelog
              </button>
              <div class="changelog" id="wds-changelog" role="region" aria-label="Windows Dictation Silence changelog">
                <p>Loading changelog...</p>
              </div>
            </div>

            <div class="install-steps">
              <h2>Installation</h2>
              <ol>
                <li>Download the <code>.nvda-addon</code> file</li>
                <li>Open the file (double-click or press Enter)</li>
                <li>Confirm installation when NVDA prompts</li>
                <li>Restart NVDA when prompted</li>
              </ol>
              <p>For addon management help, see the <a href="https://www.nvaccess.org/files/nvda/documentation/userGuide.html#AddonsManager">NVDA User Guide</a>.</p>
            </div>

            <h2>Source Code &amp; Issues</h2>
            <p>
              <a href="https://github.com/Electro-Jam-Instruments/NVDAPlugIns">GitHub Repository</a> -
              Report bugs, request features, or contribute code.
            </p>

            <footer>
              <p>&copy; 2026 Electro Jam Instruments</p>
              <p>Licensed under GPL v2.0</p>
            </footer>

            <script>
              function toggleChangelog(id) {
                const el = document.getElementById(id);
                const btn = el.previousElementSibling;
                const isShown = el.classList.toggle('show');
                btn.setAttribute('aria-expanded', isShown);
              }

              // Load changelogs dynamically
              async function loadChangelog(plugin, elementId) {
                try {
                  const response = await fetch(`api/${plugin}-changelog.md`);
                  if (response.ok) {
                    const text = await response.text();
                    // Simple markdown to HTML for changelog
                    const html = text
                      .replace(/^## \[([^\]]+)\]/gm, '<h3>Version $1</h3>')
                      .replace(/^### (.+)$/gm, '<h4>$1</h4>')
                      .replace(/^- (.+)$/gm, '<li>$1</li>')
                      .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                      .replace(/`([^`]+)`/g, '<code>$1</code>');
                    document.getElementById(elementId).innerHTML = html;
                  }
                } catch (e) {
                  console.log('Could not load changelog for ' + plugin);
                }
              }

              // Load version info
              async function loadVersionInfo(plugin, stableId, betaId, versionsId) {
                // Check if files exist by trying to fetch headers
                const stableBtn = document.getElementById(stableId);
                const betaBtn = document.getElementById(betaId);

                try {
                  const stableResp = await fetch(stableBtn.href, { method: 'HEAD' });
                  if (!stableResp.ok) {
                    stableBtn.style.display = 'none';
                  }
                } catch (e) {
                  stableBtn.style.display = 'none';
                }

                try {
                  const betaResp = await fetch(betaBtn.href, { method: 'HEAD' });
                  if (!betaResp.ok) {
                    betaBtn.style.display = 'none';
                  }
                } catch (e) {
                  betaBtn.style.display = 'none';
                }
              }

              // Initialize
              loadChangelog('powerpoint-comments', 'ppt-changelog');
              loadChangelog('windows-dictation-silence', 'wds-changelog');
              loadVersionInfo('powerpoint-comments', 'ppt-stable', 'ppt-beta', 'ppt-versions');
              loadVersionInfo('windows-dictation-silence', 'wds-stable', 'wds-beta', 'wds-versions');
            </script>
          </body>
          </html>
          HTMLEOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          keep_files: true
